---
import ThemeToggle from "./ThemeToggle.astro"
import { useTranslations, getLocalePath, type Lang } from "@/i18n"

interface Props {
  lang?: Lang
}

const { lang = "en" } = Astro.props
const t = useTranslations(lang)
const alternateLang = lang === "en" ? "es" : "en"
const alternatePath = getLocalePath(Astro.url.pathname, alternateLang)

const navItems = [
  { title: t("nav.projects"), url: `/${lang}/#projects` },
  { title: t("nav.experience"), url: `/${lang}/#experience` },
  { title: t("nav.education"), url: `/${lang}/#education` },
  { title: t("nav.about"), url: `/${lang}/#about-me` },
  { title: t("nav.blog"), url: `/${lang}/blog` },
]
---

<header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/80 backdrop-blur-lg shadow-[0_1px_12px_0] shadow-primary/5">
  <div class="mx-auto container lg:max-w-5xl flex h-14 items-center justify-between px-4">
    <a href={`/${lang}/`} class="font-semibold text-foreground tracking-tight text-sm">
      miguelfernandez<span class="text-primary">.dev</span>
    </a>

    <!-- Desktop nav -->
    <nav class="hidden sm:flex items-center gap-1">
      {
        navItems.map((link) => (
          <a
            class="px-3 py-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors rounded-md hover:bg-muted"
            href={link.url}
          >
            {link.title}
          </a>
        ))
      }
      <div class="ml-2 pl-2 border-l border-border flex items-center gap-1">
        <a
          href={alternatePath}
          class="px-2 py-1 text-xs font-medium text-muted-foreground hover:text-foreground transition-colors rounded-md hover:bg-muted uppercase"
          aria-label={`Switch to ${alternateLang === "en" ? "English" : "Español"}`}
        >
          {alternateLang.toUpperCase()}
        </a>
        <ThemeToggle />
      </div>
    </nav>

    <!-- Mobile nav -->
    <div class="flex sm:hidden items-center gap-1">
      <a
        href={alternatePath}
        class="p-1.5 text-xs font-medium text-muted-foreground hover:text-foreground transition-colors rounded-md hover:bg-muted uppercase"
        aria-label={`Switch to ${alternateLang === "en" ? "English" : "Español"}`}
      >
        {alternateLang.toUpperCase()}
      </a>
      <ThemeToggle />
      <button
        id="mobile-menu-btn"
        class="p-1.5 rounded-md text-muted-foreground hover:text-foreground hover:bg-muted transition-colors"
        aria-label="Toggle menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <svg id="menu-icon" class="size-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M4 6h16" />
          <path d="M4 12h16" />
          <path d="M4 18h16" />
        </svg>
        <svg id="close-icon" class="size-5 hidden" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M18 6l-12 12" />
          <path d="M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile dropdown -->
  <nav
    id="mobile-menu"
    class="hidden sm:hidden border-t border-border/40 bg-background/95 backdrop-blur-lg"
  >
    <div class="mx-auto container lg:max-w-5xl px-4 py-3 flex flex-col gap-1">
      {
        navItems.map((link) => (
          <a
            class="mobile-nav-link px-3 py-2 text-sm text-muted-foreground hover:text-foreground transition-colors rounded-md hover:bg-muted"
            href={link.url}
          >
            {link.title}
          </a>
        ))
      }
    </div>
  </nav>
</header>

<script is:inline>
  ;(function() {
    function initMobileMenu() {
      var mobileMenuBtn = document.getElementById("mobile-menu-btn")
      var mobileMenu = document.getElementById("mobile-menu")
      var menuIcon = document.getElementById("menu-icon")
      var closeIcon = document.getElementById("close-icon")

      if (!mobileMenuBtn) return

      mobileMenuBtn.addEventListener("click", function() {
        var isOpen = mobileMenu.classList.toggle("hidden") === false
        menuIcon.classList.toggle("hidden")
        closeIcon.classList.toggle("hidden")
        mobileMenuBtn.setAttribute("aria-expanded", isOpen ? "true" : "false")
      })

      function closeMenu() {
        mobileMenu.classList.add("hidden")
        menuIcon.classList.remove("hidden")
        closeIcon.classList.add("hidden")
        mobileMenuBtn.setAttribute("aria-expanded", "false")
      }

      document.querySelectorAll(".mobile-nav-link").forEach(function(link) {
        link.addEventListener("click", closeMenu)
      })

      document.addEventListener("click", function(e) {
        if (!mobileMenu.classList.contains("hidden") && !mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
          closeMenu()
        }
      })

      document.addEventListener("keydown", function(e) {
        if (e.key === "Escape" && !mobileMenu.classList.contains("hidden")) {
          closeMenu()
          mobileMenuBtn.focus()
        }
      })
    }

    initMobileMenu()

    if (!window.__mobileMenuListenerSet) {
      window.__mobileMenuListenerSet = true
      document.addEventListener("astro:after-swap", initMobileMenu)
    }
  })()
</script>
